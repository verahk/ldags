---
title: 'Use BiDAG-package with user-defined score'
author: "Vera Kvisgaard"
date: "2024-04-25"
output: 
  html_document:
  toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE,
	results = "hold"
)
```

This note test how the `BiDAG` package can be manipulated used to sample LDAGs. 
```{r prep}
# prep
here::i_am("./rmd/BiDAG_with_user_defined_score.Rmd")
files <- list.files(here::here("R"), ".R", full.names = T)
sapply(files, source)
```
```{r}
dag <- rbind(Z = c(0, 0, 1),
             X = c(0, 0, 1),
             Y = c(0, 0, 0))
colnames(dag) <- rownames(dag)
cpts <- setNames(vector("list", ncol(dag)), colnames(dag))
levels <- rep(list(0:1), 3)
names(levels) <- names(cpts)
nlev <- lengths(levels)
n <- length(nlev)


cpts$Z <- array(c(.1, .9), 2, levels["Z"])
cpts$X <- array(c(.9, .1), 2, levels[c("X")])
cpts$Y <- array(c(rep(c(1/3, 2/3), 3),  2/3, 1/3), 
                c(2, 2, 2), 
                levels[c("Y", "Z", "X")])

# Y indep of Z given X == 0 
cpts
```


Store as `bn.fit` object and sample data:
```{r}

g <- bnlearn::empty.graph(names(cpts))
bnlearn::amat(g) <- dag
bn <- bnlearn::custom.fit(g, cpts)

set.seed(1)
df <- bnlearn::rbn(bn, 100)
data <- sapply(df, as.numeric) -1

```


## Compute local scores of LDAGs

Define routine for computing the local score of a LDAG-node:
```{r, file = here::here("./R/famscore_csi_from_data.R")}

```
Define a user-specified scoring function that is to be called from `BiDAG`-functions.
```{r,}
#' User-defined score for 
#' 
#' See `scoretype` parameter in [BiDAG::scoreparameters].

usrDAGcorescore <- function(j, parentnodes, n, param) {
  famscore_csi_from_data(param$data, nlev, j, parentnodes, ess = 1, kappa = .5)
}

```
Also, assign this function to the name-space of `BiDAG`-package, as otherwise an internal function is called. 
```{r}
library(BiDAG)
assignInNamespace("usrDAGcorescore", usrDAGcorescore, ns = "BiDAG")
```

## Run `BiDAG::iterativeMCMC`

Define a `scoreparameters`-object for `BiDAG`'s MCMC functions. 
Note that the level of each variable is added to the list of parameters. 
I think this argument is used in the PC-algorithm-step, but it is not added when `type = "usr"`.
```{r}
scorepar <- scoreparameters("usr", 
                         data = data,
                         usrpar = list(pctesttype = "bdecat"))
scorepar$Cvec <- nlev 
```

Run iterativeMCMC: 
```{r}
iterativefit <- learnBN(scorepar, algorithm = "orderIter", scoreout = T, verbose = T)
plot(unlist(iterativefit$trace), type = "l")
summary(iterativefit)
iterSpace <- getSpace(iterativefit)

cat("\n MAP DAG and score")
iterativefit$DAG
iterativefit$score
```
PC-skeleton include all edges in this case.


Compare score of MAP-dag with that given by user-defined function:
```{r}
tmp <- sapply(seq_along(bn), 
              function(j) usrDAGcorescore(j, which(iterativefit$DAG[, j] == 1), n = length(bn), scorepar))
all(sum(tmp) == iterativefit$score)
```
```{r}
BiDAG:::DAGcorescore(3, integer(0), 3, scorepar)
BiDAG:::DAGcorescore(3, 1:2, 3, scorepar)
```
Print observed sample-frequencies:
```{r}

cat("\n observed P(Z|X, Y):\n")
counts <- table(df[, c("Z", "X", "Y")])
counts/rep(colSums(counts), each = 2)
usrDAGcorescore(1, integer(0), 3, scorepar)
usrDAGcorescore(1, c(2, 3), 3, scorepar)

cat("\n observed P(X|Z, Y):\n")
counts <- table(df[, c("X", "Z", "Y")])
counts/rep(colSums(counts), each = 2)
usrDAGcorescore(2, integer(0), 3, scorepar)
usrDAGcorescore(2, c(1, 3), 3, scorepar)

cat("\n observed P(Y|X, Z):\n")
counts <- table(df[, c("Y", "Z", "X")])
counts/rep(colSums(counts), each = 2)
usrDAGcorescore(3, integer(0), 3, scorepar)
usrDAGcorescore(3, c(1, 2), 3, scorepar)
```

# Repeath using standard BDeu-score
```{r}
scorepar <- scoreparameters("bdecat", 
                         data = df,
                         bdecatpar = list(chi = 1, edgepf = 1))
iterativefit <- learnBN(scorepar, algorithm = "orderIter", scoreout = T, verbose = T)

iterativefit$DAG
iterativefit$score
```

```{r}
BiDAG:::DAGcorescore(3, integer(0), 3, scorepar)
BiDAG:::DAGcorescore(3, 1:2, 3, scorepar)
```

